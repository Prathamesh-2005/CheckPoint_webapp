<!doctype html>
<html>
  <head>
    <title>CheckPoint - WebSocket Test</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .section {
        border: 1px solid #ccc;
        padding: 15px;
        margin: 10px 0;
        border-radius: 5px;
      }
      .section h3 {
        margin-top: 0;
      }
      input[type="text"] {
        width: 400px;
        padding: 8px;
        margin: 5px 0;
      }
      button {
        padding: 8px 15px;
        margin: 5px;
        cursor: pointer;
      }
      .connected {
        color: green;
      }
      .disconnected {
        color: red;
      }
      #notifications,
      #locations {
        min-height: 150px;
        background: #f5f5f5;
        padding: 10px;
      }
      .notification {
        padding: 5px;
        border-bottom: 1px solid #ddd;
      }
      .location {
        padding: 5px;
        background: #e8f5e9;
        margin: 5px 0;
        border-radius: 3px;
      }
    </style>
  </head>
  <body>
    <h1>üöó CheckPoint - Real-time Test</h1>

    <!-- Connection Section -->
    <div class="section">
      <h3>1. Connect to WebSocket</h3>
      <input type="text" id="token" placeholder="Paste your JWT Token here" />
      <br />
      <button onclick="connect()">Connect</button>
      <button onclick="disconnect()">Disconnect</button>
      <p>Status: <span id="status" class="disconnected">Disconnected</span></p>
    </div>

    <!-- Notifications Section -->
    <div class="section">
      <h3>2. Booking Notifications</h3>
      <div id="notifications"></div>
    </div>

    <!-- Location Section -->
    <div class="section">
      <h3>3. Location Updates</h3>
      <div>
        <input type="text" id="rideId" placeholder="Ride ID (UUID)" />
        <br />
        <button onclick="sendLocation()">Send My Location</button>
        <button onclick="getDriverLocation()">Get Driver Location</button>
        <button onclick="getPassengerLocation()">Get Passenger Location</button>
      </div>
      <h4>Received Locations:</h4>
      <div id="locations"></div>
    </div>

    <!-- Driver Actions Section -->
    <div class="section">
      <h3>4. Driver Actions (Use Postman or test here)</h3>
      <input type="text" id="actionRideId" placeholder="Ride ID" />
      <br />
      <button onclick="startRide()">Start Ride</button>
      <button onclick="completeRide()">Complete Ride</button>
    </div>

    <script>
      let stompClient = null;
      let jwtToken = "";

      function connect() {
        jwtToken = document.getElementById("token").value;
        if (!jwtToken) {
          alert("Please enter JWT token");
          return;
        }

        const socket = new SockJS("http://localhost:8080/ws");
        stompClient = Stomp.over(socket);

        const headers = {
          Authorization: "Bearer " + jwtToken,
        };

        stompClient.connect(
          headers,
          function (frame) {
            document.getElementById("status").innerText = "Connected ‚úì";
            document.getElementById("status").className = "connected";

            // Subscribe to notifications
            stompClient.subscribe(
              "/user/queue/notifications",
              function (message) {
                const notification = JSON.parse(message.body);
                showNotification(notification);
              },
            );

            // Subscribe to location updates
            stompClient.subscribe("/user/queue/location", function (message) {
              const location = JSON.parse(message.body);
              showLocation(location);
            });

            console.log("Connected: " + frame);
          },
          function (error) {
            document.getElementById("status").innerText = "Error: " + error;
            document.getElementById("status").className = "disconnected";
          },
        );
      }

      function disconnect() {
        if (stompClient !== null) {
          stompClient.disconnect();
        }
        document.getElementById("status").innerText = "Disconnected";
        document.getElementById("status").className = "disconnected";
      }

      function showNotification(notification) {
        const div = document.getElementById("notifications");
        const time = new Date().toLocaleTimeString();
        div.innerHTML =
          `<div class="notification"><strong>[${time}] ${notification.type}</strong>: ${notification.message}</div>` +
          div.innerHTML;
      }

      function showLocation(location) {
        const div = document.getElementById("locations");
        const time = new Date().toLocaleTimeString();
        div.innerHTML =
          `<div class="location">
                <strong>[${time}] ${location.userType}</strong> (${location.userName})<br>
                üìç Lat: ${location.latitude}, Lng: ${location.longitude}
            </div>` + div.innerHTML;
      }

      function sendLocation() {
        const rideId = document.getElementById("rideId").value;
        if (!rideId) {
          alert("Please enter Ride ID");
          return;
        }

        // Get current location
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            function (position) {
              const locationData = {
                rideId: rideId,
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
              };

              // Send via REST API
              fetch("http://localhost:8080/api/location/update", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: "Bearer " + jwtToken,
                },
                body: JSON.stringify(locationData),
              })
                .then((response) => response.json())
                .then((data) => {
                  console.log("Location sent:", data);
                  alert("Location sent successfully!");
                })
                .catch((error) => {
                  console.error("Error:", error);
                  alert("Failed to send location");
                });
            },
            function (error) {
              alert("Geolocation error: " + error.message);
            },
          );
        } else {
          alert("Geolocation not supported");
        }
      }

      function getDriverLocation() {
        const rideId = document.getElementById("rideId").value;
        if (!rideId) {
          alert("Please enter Ride ID");
          return;
        }

        fetch(`http://localhost:8080/api/location/driver/${rideId}`, {
          headers: {
            Authorization: "Bearer " + jwtToken,
          },
        })
          .then((response) => response.json())
          .then((data) => {
            showLocation(data);
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("Failed to get driver location");
          });
      }

      function getPassengerLocation() {
        const rideId = document.getElementById("rideId").value;
        if (!rideId) {
          alert("Please enter Ride ID");
          return;
        }

        fetch(`http://localhost:8080/api/location/passenger/${rideId}`, {
          headers: {
            Authorization: "Bearer " + jwtToken,
          },
        })
          .then((response) => response.json())
          .then((data) => {
            showLocation(data);
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("Failed to get passenger location");
          });
      }

      function startRide() {
        const rideId = document.getElementById("actionRideId").value;
        if (!rideId) {
          alert("Please enter Ride ID");
          return;
        }

        fetch(`http://localhost:8080/api/rides/${rideId}/start`, {
          method: "PATCH",
          headers: {
            Authorization: "Bearer " + jwtToken,
          },
        })
          .then((response) => response.json())
          .then((data) => {
            console.log("Ride started:", data);
            alert("Ride started! Status: " + data.status);
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("Failed to start ride");
          });
      }

      function completeRide() {
        const rideId = document.getElementById("actionRideId").value;
        if (!rideId) {
          alert("Please enter Ride ID");
          return;
        }

        fetch(`http://localhost:8080/api/rides/${rideId}/complete`, {
          method: "PATCH",
          headers: {
            Authorization: "Bearer " + jwtToken,
          },
        })
          .then((response) => response.json())
          .then((data) => {
            console.log("Ride completed:", data);
            alert("Ride completed! Status: " + data.status);
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("Failed to complete ride");
          });
      }
    </script>
  </body>
</html>
